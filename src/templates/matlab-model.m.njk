{% macro idOrSynonim(component) %}{# if no Synonim in yTranslator, than use id #}
{%- if yTranslator.symbolName[component.id] -%}
{{ yTranslator.symbolName[component.id] }}
{%- else -%}
{{ component.id }}
{%- endif -%}
{% endmacro -%}
{#-
  constants : all constants
  initRecords : all records SORTED by start_ and have start_ or isRule
-#}

%%%% This code was generated by {{ builderName }}
% {{ options.title + '.' if options.title }}{{ options.notes }}

function [ode_func, out_func, y0_, events_conditions, events_affects] = {{ namespace.spaceName }}_Model(p)

    %%% auxilary
    % ternary operator
    function out = tern__(cond, x, y)
        if cond
            out = x;
        else
            out = y;
        end
    end

    ode_func = @ODEFunc;
    out_func = @OutputFunc;
    events_conditions = @Conditions;
    events_affects = {
    {%- for event in events -%}
        @{{ event.switcher.id }}_affect{{ ', ' if not loop.last }}
    {%- endfor -%}
    };
    y0_ = InitFunc();

    % shared variable
    shared_values = zeros(1, {{ outputRecords|length }});
    integrator = [];

    %%% Initialization of dynamic records
    function y__ = InitFunc()
        integrator = []; % reset integrator
        time = 0; % zero time

        {%- for record in initRecords %}
        {% if record.getAssignment('start_') is defined -%}
        {{ record.id }} = {{ record.getAssignment('start_').translate(pTranslator).toMatlabString() }}; % {{ record.id }}, {{ record.title }} ({{ record.units }})
        {%- else -%}
        {{ record.id }} = {{ record.getAssignment('ode_').translate(pTranslator).toMatlabString() }}; % {{ record.id }}, {{ record.title }} ({{ record.units }})
        {%- endif -%}
        {%- endfor %}

        % before reinitialization
        y0__ = [{% for record in dynamicRecords %}
        {%- if record.instanceOf('Species') and not record.isAmount and not record.isRule -%}
            {{ record.id }} * {{ record.compartment }}{{ '; ' if not loop.last }}
        {%- else -%}
            {{ record.id }}{{ '; ' if not loop.last }}
        {%- endif %}
        {%- endfor %}];

        % reinitialization by events
        y__ = ReinitY0(time, y0__);
    end

    %%% Check events conditions at `zero`
    function y__ = ReinitY0(time, y0)
        
        cond_zero = Conditions(time, y0);
        ev_idxs = find(cond_zero==0, 1);
        
        if ~isempty(ev_idxs)
            for idx = 1:length(ev_idxs)
                ev = events_affects(idx);
                y__ = ev{1}(0.0,y0);
            end
        else
            y__ = y0;
        end
    end

    function status = OutputFunc(time, y, flag)
        switch flag
            case 'done'
                assignin('base', 'output', integrator);
            case 'affect'
                integrator(end, :) = shared_values;
            otherwise
                integrator = [integrator; shared_values];
        end
        status = 0;
    end

    function dydt = ODEFunc(time, y)

        dydt = zeros({{ dynamicRecords|length }}, 1);

        %%% Dynamic records annotation
        {%- for record in dynamicRecords %}
        %{{ loop.index }} - {{ record.id }}, {{ record.title }} ({{ record.units }}) {{ record.notes }}
        {%- endfor %}

        %%% Output records
        {%- for record in outputRecords %}
        % {{ record.title }} ({{ record.units }}) {{ record.notes }}
        {% if record.isRule -%}
        {{ record.id }} = {{ record.assignments.ode_.translate(pTranslator).toMatlabString() }};
        {%- elif record.instanceOf('Species') and not record.isAmount -%}
        {{ record.id }} = {{ yTranslator.symbolName[record.id] }} / {{ record.compartment }};
        {%- else -%}
        {{ record.id }} = {{ yTranslator.symbolName[record.id] }};
        {%- endif -%}
        {%- endfor %}
        shared_values = [{% for record in outputRecords -%}
        {{ record.id }}{{ ', ' if not loop.last }}
        {%- endfor %}];

        %%% Differential equations
        {%- for record in dynamicRecords %}
        dydt({{ loop.index }}) = {{ rhs[loop.index0] }};
        {%- endfor %}
    end

    {% for event in events | filter2('switcher.className', 'TimeSwitcher') %}
    function res = {{ event.switcher.id }}_condition(time, y)
        {%- set ev_start = pTranslator.symbolName[event.switcher.start] if event.switcher.start is defined else event.switcher.startObj.numFloat %}
        {%- set ev_period = pTranslator.symbolName[event.switcher.period] if event.switcher.period is defined else event.switcher.periodObj.numFloat %}
        {%- set ev_stop = pTranslator.symbolName[event.switcher.stop] if event.switcher.stop is defined else event.switcher.stopObj.numFloat %}

        {% if ev_period is undefined -%}
        res = time - {{ ev_start }};
        {%- else -%}
        if (time - {{ ev_start }} <= 0.) || ({{ ev_period }} <= 0)
            res = time - {{ ev_start }};
        elseif (0. < time - {{ ev_start }}) && (time < {{ ev_stop if ev_stop is defined else 'Inf' }})
            res = (time - {{ ev_start }}) - floor((time - {{ ev_start }})/{{ ev_period }} + 0.5)*{{ ev_period }};
        else
            res = time - {{ ev_stop if ev_stop is defined else 'Inf' }};
        end
        {%- endif %}
    end
    {%- endfor %}

    {%- for event in events | filter2('switcher.className', 'DSwitcher') %}
    function res = {{ event.switcher.id }}_condition(time, y)
 
        %%% Records
        {%- for record in outputRecords %}
        % {{ record.title }} ({{ record.units }}) {{ record.notes }}
        {% if record.isRule -%}
        {{ record.id }} = {{ record.assignments.ode_.translate(pTranslator).toMatlabString() }};
        {%- elif record.instanceOf('Species') and not record.isAmount -%}
        {{ record.id }} = {{ yTranslator.symbolName[record.id] }} / {{ record.compartment }};
        {%- else -%}
        {{ record.id }} = {{ yTranslator.symbolName[record.id] }};
        {%- endif -%}
        {%- endfor %}

        if ({{ event.switcher.trigger.translate(pTranslator).toMatlabString() if event.switcher.trigger is defined else 'false' }})
            res = 1;
        else 
            res = -1;
        end
    end
    {%- endfor %}

    {%- for event in events | filter2('switcher.className', 'CSwitcher') %}
    function res = {{ event.switcher.id }}_condition(time, y)
 
        %%% Records
        {%- for record in outputRecords %}
        % {{ record.title }} ({{ record.units }}) {{ record.notes }}
        {% if record.isRule -%}
        {{ record.id }} = {{ record.assignments.ode_.translate(pTranslator).toMatlabString() }};
        {%- elif record.instanceOf('Species') and not record.isAmount -%}
        {{ record.id }} = {{ yTranslator.symbolName[record.id] }} / {{ record.compartment }};
        {%- else -%}
        {{ record.id }} = {{ yTranslator.symbolName[record.id] }};
        {%- endif -%}
        {%- endfor %}

        res = {{ event.switcher.trigger.translate(pTranslator).toMatlabString() if event.switcher.trigger is defined else '-1' }};
    end
    {%- endfor %}

    {%- for event in events %}
    function y = {{ event.switcher.id }}_affect(time, y)

        %%% Records
        {%- for record in outputRecords %}
        % {{ record.title }} ({{ record.units }}) {{ record.notes }}
        {% if record.isRule -%}
        {{ record.id }} = {{ record.assignments.ode_.translate(pTranslator).toMatlabString() }};
        {%- elif record.instanceOf('Species') and not record.isAmount -%}
        {{ record.id }} = {{ yTranslator.symbolName[record.id] }} / {{ record.compartment }};
        {%- else -%}
        {{ record.id }} = {{ yTranslator.symbolName[record.id] }};
        {%- endif -%}
        {%- endfor %}

        if time ~= 0
            shared_values = [
            {%- for record in outputRecords -%}
            {{ record.id }}{{ ', ' if not loop.last }}
            {%- endfor -%}
            ];
            OutputFunc(time, y, 'affect');
        end

        %%% recalculated values
        {%- for assignment in event.affect %}
        {% if assignment.instanceOf('Species') and not assignment.isAmount and not assignment.isRule -%}
        {{ idOrSynonim(assignment) }} = ({{ assignment.getAssignment(event.switcher.id).translate(pTranslator).toMatlabString() }}) * {{ assignment.compartment }};
        {%- else -%}
        {{ idOrSynonim(assignment) }} = {{ assignment.getAssignment(event.switcher.id).translate(pTranslator).toMatlabString() }};
        {%- endif -%}
        {%- endfor %}
        
    end
    {%- endfor %}

    function [res,isterminal,direction] = Conditions(time, y)
        direction = ones({{ events|length }}, 1);
        isterminal = ones({{ events|length }}, 1);
        res = [
            {%- for event in events -%}
                {{ event.switcher.id }}_condition(time, y){{ '; ' if not loop.last }}
            {%- endfor -%}
        ];     
    end
end
