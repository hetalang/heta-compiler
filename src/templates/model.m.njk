{% macro idOrSynonim(component) %}{# if no Synonim in yTranslator, than use id #}
{%- if yTranslator.symbolName[component.id] -%}
{{ yTranslator.symbolName[component.id] }}
{%- else -%}
{{ component.id }}
{%- endif -%}
{% endmacro -%}
{#-
  constants : all constants
  initRecords : all records SORTED by start_ and have start_ or isRule
-#}

%%%% This code was generated by {{ builderName }}
% {{ options.title + '.' if options.title }}{{ options.notes }}

function [ode_func, out_func, y0_, events_] = {{ namespace.spaceName }}_Model(p)

    ode_func = @ODEFunc;
    out_func = @OutputFunc;
    y0_ = InitFunc();

    % shared variable
    shared_values = zeros(1, {{ outputRecords|length }});
    integrator = [];

    %%% Initialization of dynamic records
    function y__ = InitFunc()
        integrator = []; % reset integrator

        {%- for record in initRecords %}
        {% if record.getAssignment('start_') is defined -%}
        {{ record.id }} = {{ record.getAssignment('start_').translate(pTranslator).toMatlabString() }}; % {{ record.id }}, {{ record.title }} ({{ record.units }})
        {%- else -%}
        {{ record.id }} = {{ record.getAssignment('ode_').translate(pTranslator).toMatlabString() }}; % {{ record.id }}, {{ record.title }} ({{ record.units }})
        {%- endif -%}
        {%- endfor %}

        y__ = [{% for record in dynamicRecords %}
        {%- if record.instanceOf('Species') and not record.isAmount and not record.isRule -%}
            {{ record.id }} * {{ record.compartment }}{{ '; ' if not loop.last }}
        {%- else -%}
            {{ record.id }}{{ '; ' if not loop.last }}
        {%- endif %}
        {%- endfor %}];
    end

    function status = OutputFunc(t, y, flag)
        switch flag
            case 'done'
                assignin('base', 'output', integrator);
            case 'affect'
                integrator(end, :) = shared_values;
            otherwise
                integrator = [integrator; shared_values];
        end
        status = 0;
    end

    function dydt = ODEFunc(t, y)

        dydt = zeros({{ dynamicRecords|length }}, 1);

        %%% Dynamic records annotation
        {%- for record in dynamicRecords %}
        %{{ loop.index }} - {{ record.id }}, {{ record.title }} ({{ record.units }}) {{ record.notes }}
        {%- endfor %}

        %%% Output records
        {%- for record in outputRecords %}
        % {{ record.title }} ({{ record.units }}) {{ record.notes }}
        {% if record.isRule -%}
        {{ record.id }} = {{ record.assignments.ode_.translate(pTranslator).toMatlabString() }};
        {%- elif record.instanceOf('Species') and not record.isAmount -%}
        {{ record.id }} = {{ yTranslator.symbolName[record.id] }} / {{ record.compartment }};
        {%- else -%}
        {{ record.id }} = {{ yTranslator.symbolName[record.id] }};
        {%- endif -%}
        {%- endfor %}
        shared_values = [{% for record in outputRecords -%}
        {{ record.id }}{{ ', ' if not loop.last }}
        {%- endfor %}];

        %%% Differential equations
        {%- for record in dynamicRecords %}
        dydt({{ loop.index }}) = {{ rhs[loop.index0] }};
        {%- endfor %}
    end

    {% for event in events -%}
    function [res, isterminal, direction] = {{ event.switcher.id }}_condition(t, y)
        direction = 1; % [];
        isterminal = 1;
        
        ev_start = {{ event.switcher.startObj.num }};
        ev_period = {{ event.switcher.periodObj.num if event.switcher.periodObj.num is defined else '[]'}};
        ev_repeatCount = {{ event.switcher.getRepeatCountInt() }};
        
        flag = (t - ev_start)/ev_period;
        
        if flag <= 0.
            res = flag;
        elseif (0. < flag) && (flag < ev_repeatCount)
            res = flag - floor(flag + 0.5);
        else
            res = flag - ev_repeatCount;
        end
    end
    function y = {{ event.switcher.id }}_affect(t, y)

        %%% Records
        {%- for record in outputRecords %}
        % {{ record.title }} ({{ record.units }}) {{ record.notes }}
        {% if record.isRule -%}
        {{ record.id }} = {{ record.assignments.ode_.translate(pTranslator).toMatlabString() }};
        {%- elif record.instanceOf('Species') and not record.isAmount -%}
        {{ record.id }} = {{ yTranslator.symbolName[record.id] }} / {{ record.compartment }};
        {%- else -%}
        {{ record.id }} = {{ yTranslator.symbolName[record.id] }};
        {%- endif -%}
        {%- endfor %}
        
        shared_values = [{% for record in outputRecords -%}
        {{ record.id }}{{ ', ' if not loop.last }}
        {%- endfor %}];
        OutputFunc(t, y, 'affect');

        %%% recalculated values
        {%- for assignment in event.affect %}
        {% if assignment.instanceOf('Species') and not assignment.isAmount and not assignment.isRule -%}
        {{ idOrSynonim(assignment) }} = ({{ assignment.getAssignment(event.switcher.id).translate(pTranslator).toMatlabString() }}) * {{ assignment.compartment }};
        {%- else -%}
        {{ idOrSynonim(assignment) }} = {{ assignment.getAssignment(event.switcher.id).translate(pTranslator).toMatlabString() }};
        {%- endif -%}
        {%- endfor %}
        
    end
    {{ event.switcher.id }}_ = { @{{ event.switcher.id }}_condition, @{{ event.switcher.id }}_affect };
    {%- endfor %}

    events_ = [
    {%- for event in events %}{{ event.switcher.id }}_{{ ', ' if not loop.last }}{% endfor -%}
    ];
end